// üîÑ src/components/pen-history/TeljesKaramTortenelem_v2.tsx
// Refaktor√°lt verzi√≥ - modul√°ris √©s tiszt√≠tott

'use client';

import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { syncHaremData, createHistoricalSnapshot } from '@/lib/utils/haremSync';
import AnimalSelector from '@/components/AnimalSelector';
import EventTimeline from './EventTimeline';
import { BullAssignmentService, type TenyeszBika, type AssignmentResult } from '@/lib/services/BullAssignmentService';

// üîπ INTERFACES (tiszt√≠tott)
interface KombinaltEsemeny {
  id: string;
  animal_id: number;
  datum: string;
  idopont: string;
  tipus: 'event' | 'movement';
  forr√°s: 'animal_events' | 'animal_movements';
  from_pen?: string;
  to_pen: string;
  ok: string;
  funkci?: string;
  megjegyzes?: string;
  metadata?: any;
  function_metadata?: any;
  pen_number?: string;
  pen_location?: string;
  animal_enar?: string;
  animal_kategoria?: string;
  animal_pregnancy_status?: string;
}

interface FormData {
  datum: string;
  idopont: string;
  esemenyTipus: 'pen_assignment' | 'pen_movement' | 'function_change' | 'breeding' | 'pregnancy' | 'birth' | 'medical' | 'quarantine' | 'culling' | 'breeding_entry' | 'harem_entry' | 'other';
  funkci: string;
  kivalasztottBikak: string[];
  hovaPen: string;
  megjegyzes: string;
  torteneti: boolean;
  haremKezdete?: string;
  selectedAnimals: number[];
}

interface TeljesKaramTortenelem_v2_Props {
  penId?: string;
  animalId?: number;
  penNumber?: string;
  penLocation?: string;
  onDataChange?: () => void;
  mode?: 'pen' | 'animal' | 'view-only';
}

// üîπ UTILITY FUNCTIONS
const formatHungarianDate = (dateString: string): string => {
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('hu-HU', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });
  } catch {
    return dateString;
  }
};

const translateReason = (reason: string): string => {
  const translations: { [key: string]: string } = {
    'breeding': 'Teny√©szt√©s',
    'pregnancy': 'Vemhess√©g',
    'birth': 'Ell√©s',
    'medical': 'Orvosi kezel√©s',
    'quarantine': 'Karant√©n',
    'culling': 'Selejtez√©s',
    'breeding_entry': 'Teny√©szt√©sbe √°ll√≠t√°s',
    'harem_entry': 'H√°rembe helyez√©s',
    'other': 'Egy√©b',
    'weaning': 'V√°laszt√°s',
    'sale': '√ârt√©kes√≠t√©s',
    'death': 'Elhull√°s',
    'pen_movement': 'Kar√°m v√°lt√°s',
    'pen_assignment': 'Kar√°m hozz√°rendel√©s',
    'function_change': 'Funkci√≥ v√°lt√°s'
  };
  return translations[reason] || reason;
};

// üéØ MAIN COMPONENT
const TeljesKaramTortenelem_v2: React.FC<TeljesKaramTortenelem_v2_Props> = ({
  penId,
  animalId,
  penNumber = 'Ismeretlen',
  penLocation = '',
  onDataChange,
  mode = 'pen'
}) => {
  // üîπ STATE MANAGEMENT (egyszer≈±s√≠tett)
  const [kombinaltEsemenyek, setKombinaltEsemenyek] = useState<KombinaltEsemeny[]>([]);
  const [availableBulls, setAvailableBulls] = useState<TenyeszBika[]>([]);
  const [availablePens, setAvailablePens] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Modal √©s form state
  const [showModal, setShowModal] = useState(false);
  const [editingEvent, setEditingEvent] = useState<KombinaltEsemeny | null>(null);
  
  // Pagination √©s sz≈±r√©s
  const [currentPage, setCurrentPage] = useState(1);
  const [eventsPerPage] = useState(20);
  const [eventFilter, setEventFilter] = useState<'all' | 'harem' | 'movement'>('all');
  
  // Form data
  const [formData, setFormData] = useState<FormData>({
    datum: new Date().toISOString().split('T')[0],
    idopont: '12:00',
    esemenyTipus: 'function_change',
    funkci: 'h√°rem',
    kivalasztottBikak: [],
    hovaPen: '',
    megjegyzes: '',
    torteneti: false,
    selectedAnimals: [],
  });

  // üîπ EFFECT HOOKS
  useEffect(() => {
    loadAllData();
  }, [penId, animalId]);

  // üîπ DATA LOADING (optimaliz√°lt)
  const loadAllData = async () => {
    try {
      setLoading(true);
      setError(null);

      if (!animalId && mode === 'animal') {
        setError('Animal ID hi√°nyzik!');
        setLoading(false);
        return;
      }

      await Promise.all([
        loadEvents(),
        loadBulls(),
        loadPens()
      ]);

      setLoading(false);
    } catch (error) {
      console.error('üí• Adatbet√∂lt√©si hiba:', error);
      setError((error as Error).message);
      setLoading(false);
    }
  };

  const loadEvents = async () => {
    try {
      const kombinalt: KombinaltEsemeny[] = [];

      // Animal events bet√∂lt√©se
      let eventsQuery = supabase
        .from('animal_events')
        .select('*')
        .order('event_date', { ascending: false });

      if (penId) {
        eventsQuery = eventsQuery.eq('pen_id', penId);
      }
      if (animalId) {
        eventsQuery = eventsQuery.eq('animal_id', animalId);
      }

      const { data: events, error: eventsError } = await eventsQuery;

      if (!eventsError && events) {
        // Batch lek√©rdez√©sek a nevek/metaadatokhoz
        const animalIds = [...new Set(events.map(e => e.animal_id).filter(Boolean))];
        const penIds = [...new Set(events.map(e => e.pen_id).filter(Boolean))];

        // √Ållat nevek √©s kateg√≥ri√°k
        let animalNames: { [key: number]: any } = {};
        if (animalIds.length > 0) {
          const { data: animalsData } = await supabase
            .from('animals')
            .select('id, enar, kategoria, pregnancy_status')
            .in('id', animalIds);

          if (animalsData) {
            animalNames = animalsData.reduce((acc: { [key: number]: any }, animal: any) => {
              acc[animal.id] = {
                enar: animal.enar,
                kategoria: animal.kategoria,
                pregnancy_status: animal.pregnancy_status
              };
              return acc;
            }, {});
          }
        }

        // Kar√°m nevek
        let penNames: { [key: string]: { pen_number: string, location: string } } = {};
        if (penIds.length > 0) {
          const { data: pensData } = await supabase
            .from('pens')
            .select('id, pen_number, location')
            .in('id', penIds);

          if (pensData) {
            penNames = pensData.reduce((acc: { [key: string]: any }, pen: any) => {
              acc[pen.id] = { pen_number: pen.pen_number, location: pen.location };
              return acc;
            }, {});
          }
        }

        // Events konvert√°l√°sa
        events.forEach(event => {
          kombinalt.push({
            id: `event_${event.id}`,
            animal_id: event.animal_id,
            datum: event.event_date,
            idopont: event.event_time || '12:00',
            tipus: 'event',
            forr√°s: 'animal_events',
            from_pen: event.previous_pen_id,
            to_pen: event.pen_id,
            ok: event.reason || event.event_type || 'Esem√©ny',
            funkci: event.pen_function,
            megjegyzes: event.notes,
            metadata: event.function_metadata,
            function_metadata: event.function_metadata,
            pen_number: penNames[event.pen_id]?.pen_number || `Kar√°m ID: ${event.pen_id}`,
            pen_location: penNames[event.pen_id]?.location || '',
            animal_enar: animalNames[event.animal_id]?.enar || `ID: ${event.animal_id}`,
            animal_kategoria: animalNames[event.animal_id]?.kategoria || 'unknown',
            animal_pregnancy_status: animalNames[event.animal_id]?.pregnancy_status || null
          });
        });
      }

      // Animal movements bet√∂lt√©se
      let movementsQuery = supabase
        .from('animal_movements')
        .select(`
          *,
          function_metadata,
          animals!inner(enar)
        `)
        .order('moved_at', { ascending: false });

      if (penId) {
        movementsQuery = movementsQuery.or(`from_pen_id.eq.${penId},to_pen_id.eq.${penId}`);
      }
      if (animalId) {
        movementsQuery = movementsQuery.eq('animal_id', animalId);
      }

      const { data: movements, error: movementsError } = await movementsQuery;

      if (!movementsError && movements) {
        const penIds = [...new Set(movements.map(m => m.to_pen_id).filter(Boolean))];
        let penNames: { [key: string]: string } = {};

        if (penIds.length > 0) {
          const { data: pensData } = await supabase
            .from('pens')
            .select('id, pen_number')
            .in('id', penIds);

          if (pensData) {
            penNames = pensData.reduce((acc: { [key: string]: string }, pen: any) => {
              acc[pen.id] = pen.pen_number;
              return acc;
            }, {});
          }
        }

        movements.forEach(movement => {
          kombinalt.push({
            id: `movement_${movement.id}`,
            animal_id: movement.animal_id,
            datum: movement.moved_at.split('T')[0],
            idopont: movement.moved_at.split('T')[1]?.substring(0, 5) || '12:00',
            tipus: 'movement',
            forr√°s: 'animal_movements',
            from_pen: movement.from_pen_id,
            to_pen: movement.to_pen_id,
            ok: movement.movement_reason || movement.function_type || 'Mozgat√°s',
            funkci: movement.function_type,
            megjegyzes: movement.notes,
            metadata: movement.function_metadata,
            function_metadata: movement.function_metadata,
            pen_number: penNames[movement.to_pen_id] || `Kar√°m ID: ${movement.to_pen_id}`,
            pen_location: '',
            animal_enar: movement.animals?.enar
          });
        });
      }

      // Duplik√°tum sz≈±r√©s √©s rendez√©s
      const uniqueEvents = new Map();
      kombinalt.forEach(event => {
        const uniqueKey = `${event.animal_id}_${event.datum}_${event.idopont}_${event.ok}`;
        if (!uniqueEvents.has(uniqueKey)) {
          uniqueEvents.set(uniqueKey, event);
        }
      });

      const finalEvents = Array.from(uniqueEvents.values());
      finalEvents.sort((a, b) => {
        const dateA = new Date(`${a.datum}T${a.idopont}`);
        const dateB = new Date(`${b.datum}T${b.idopont}`);
        return dateB.getTime() - dateA.getTime();
      });

      setKombinaltEsemenyek(finalEvents);

    } catch (error) {
      console.error('‚ùå Esem√©nyek bet√∂lt√©si hiba:', error);
    }
  };

  const loadBulls = async () => {
    try {
      const bulls = await BullAssignmentService.getAvailableBulls();
      setAvailableBulls(bulls);
    } catch (error) {
      console.error('‚ùå Bik√°k bet√∂lt√©se hiba:', error);
    }
  };

  const loadPens = async () => {
    try {
      const { data, error } = await supabase
        .from('pens')
        .select('id, pen_number, location, pen_type')
        .order('pen_number');

      if (error) throw error;
      setAvailablePens(data || []);
    } catch (error) {
      console.error('‚ùå Karamok bet√∂lt√©se hiba:', error);
    }
  };

  // üîπ EVENT HANDLERS (egyszer≈±s√≠tett)
  const openModal = (event?: KombinaltEsemeny) => {
    if (event) {
      setEditingEvent(event);
      setFormData({
        datum: event.datum,
        idopont: event.idopont,
        esemenyTipus: 'function_change',
        funkci: event.funkci || 'h√°rem',
        kivalasztottBikak: event.function_metadata?.bulls?.map((b: any) => b.id) || [],
        hovaPen: event.to_pen,
        megjegyzes: event.megjegyzes || '',
        torteneti: false,
        haremKezdete: event.function_metadata?.pairing_start_date || event.datum,
        selectedAnimals: []
      });
    } else {
      setEditingEvent(null);
      setFormData({
        ...formData,
        hovaPen: penId || '',
        haremKezdete: undefined,
        selectedAnimals: []
      });
    }
    setShowModal(true);
  };

  const handleSave = async () => {
    try {
      // Valid√°ci√≥
      if (!formData.datum || !formData.funkci) {
        alert('‚ö†Ô∏è D√°tum √©s funkci√≥ k√∂telez≈ë!');
        return;
      }

      if (mode === 'pen' && !editingEvent && formData.selectedAnimals.length === 0) {
        alert('‚ö†Ô∏è Kar√°m m√≥dban v√°lassz ki legal√°bb egy √°llatot!');
        return;
      }

      if (mode === 'animal' && !animalId) {
        alert('‚ö†Ô∏è √Ållat ID hi√°nyzik!');
        return;
      }

      let metadata = {};

      // H√°rem metadata kezel√©s
      if (formData.funkci === 'h√°rem' && formData.kivalasztottBikak.length > 0) {
        const haremKezdete = formData.haremKezdete || formData.datum;
        const vvDatum = new Date(haremKezdete);
        vvDatum.setDate(vvDatum.getDate() + 75);

        const selectedBulls = availableBulls.filter(bika =>
          formData.kivalasztottBikak.includes(bika.id)
        );

        if (formData.torteneti) {
          // T√∂rt√©neti snapshot
          try {
            let specificAnimals: any[] = [];
            if (formData.selectedAnimals.length > 0) {
              const { data: selectedAnimalsData } = await supabase
                .from('animals')
                .select('enar, kategoria, ivar')
                .in('id', formData.selectedAnimals);

              specificAnimals = selectedAnimalsData || [];
            }

            const fullSnapshot = await createHistoricalSnapshot(
              formData.hovaPen,
              selectedBulls,
              haremKezdete,
              vvDatum.toISOString().split('T')[0],
              specificAnimals
            );

            metadata = {
              ...fullSnapshot,
              historical_entry: true,
              created_via: 'manual_historical_event_v2',
              snapshot_date: formData.datum
            };
          } catch (snapshotError) {
            console.warn('‚ö†Ô∏è T√∂rt√©neti snapshot hiba:', snapshotError);
            metadata = {
              bulls: selectedBulls.map(bika => ({
                id: bika.id,
                name: bika.name,
                enar: bika.enar,
                kplsz: bika.kplsz
              })),
              pairing_start_date: haremKezdete,
              expected_vv_date: vvDatum.toISOString().split('T')[0],
              breeding_method: 'natural',
              historical_entry: true,
              created_via: 'manual_event_fallback_v2'
            };
          }
        } else {
          // Akt√≠v esem√©ny
          metadata = {
            bulls: selectedBulls.map(bika => ({
              id: bika.id,
              name: bika.name,
              enar: bika.enar,
              kplsz: bika.kplsz
            })),
            pairing_start_date: haremKezdete,
            expected_vv_date: vvDatum.toISOString().split('T')[0],
            breeding_method: 'natural',
            historical_entry: false,
            created_via: 'manual_active_event_v2'
          };
        }

        // ‚úÖ FIZIKAI JELENL√âT BIZTOS√çT√ÅSA (BullAssignmentService haszn√°lata)
        if (!formData.torteneti && formData.kivalasztottBikak.length > 0) {
          try {
            const physicalResult = await BullAssignmentService.assignBullsToPen(
              selectedBulls,
              formData.hovaPen,
              false
            );

            if (physicalResult.success && physicalResult.addedBulls > 0) {
              console.log(`üêÇ ${physicalResult.addedBulls} teny√©szbika fizikailag hozz√°rendelve!`);
            }
          } catch (physicalError) {
            console.warn('‚ö†Ô∏è Fizikai jelenl√©t biztos√≠t√°sa hiba:', physicalError);
          }
        }
      }

      // Esem√©ny ment√©se
      if (editingEvent) {
        // SZERKESZT√âS
        const realId = editingEvent.id.replace('event_', '').replace('movement_', '');

        if (editingEvent.forr√°s === 'animal_events') {
          const updateData: any = {
            event_date: formData.datum,
            event_time: formData.idopont,
            pen_function: formData.funkci,
            pen_id: formData.hovaPen,
            reason: translateReason(formData.esemenyTipus),
            notes: formData.megjegyzes
          };

          if (formData.funkci === 'h√°rem') {
            updateData.function_metadata = metadata;
          }

          const { error } = await supabase
            .from('animal_events')
            .update(updateData)
            .eq('id', realId);

          if (error) throw error;
        }
      } else {
        // √öJ ESEM√âNY
        if (mode === 'pen' && formData.selectedAnimals.length > 0) {
          const events = formData.selectedAnimals.map(selectedAnimalId => ({
            animal_id: selectedAnimalId,
            event_type: formData.esemenyTipus,
            event_date: formData.datum,
            event_time: formData.idopont,
            pen_id: formData.hovaPen,
            pen_function: formData.funkci,
            function_metadata: metadata,
            reason: translateReason(formData.esemenyTipus),
            notes: formData.megjegyzes,
            is_historical: formData.torteneti
          }));

          const { error } = await supabase.from('animal_events').insert(events);
          if (error) throw error;

        } else if (mode === 'animal' && animalId) {
          const { error } = await supabase.from('animal_events').insert({
            animal_id: animalId,
            event_type: formData.esemenyTipus,
            event_date: formData.datum,
            event_time: formData.idopont,
            pen_id: formData.hovaPen,
            pen_function: formData.funkci,
            function_metadata: metadata,
            reason: translateReason(formData.esemenyTipus),
            notes: formData.megjegyzes,
            is_historical: formData.torteneti
          });

          if (error) throw error;
        }
      }

      // Szinkroniz√°ci√≥
      if (formData.funkci === 'h√°rem' && !editingEvent && !formData.torteneti) {
        setTimeout(async () => {
          const syncResult = await syncHaremData(formData.hovaPen);
          if (syncResult.success) {
            console.log('‚úÖ H√°rem szinkroniz√°ci√≥ sikeres');
          }
        }, 1000);
      }

      alert(`‚úÖ Esem√©ny sikeresen ${editingEvent ? 'friss√≠tve' : 'r√∂gz√≠tve'}!`);

      setShowModal(false);
      setEditingEvent(null);

      if (onDataChange) {
        onDataChange();
      }

      await loadAllData();

    } catch (error) {
      console.error('‚ùå Ment√©si hiba:', error);
      alert('‚ùå Hiba t√∂rt√©nt a ment√©s sor√°n: ' + (error as Error).message);
    }
  };

  const handleDelete = async (event: KombinaltEsemeny) => {
    if (!confirm(`‚ö†Ô∏è Biztosan t√∂r√∂lni akarod ezt az esem√©nyt?\n\nD√°tum: ${formatHungarianDate(event.datum)}\n√Ållat: ${event.animal_enar}`)) {
      return;
    }

    try {
      const tableName = event.forr√°s === 'animal_events' ? 'animal_events' : 'animal_movements';
      const realId = event.id.replace('event_', '').replace('movement_', '');

      const { error } = await supabase
        .from(tableName)
        .delete()
        .eq('id', realId);

      if (error) throw error;

      await loadAllData();

      if (onDataChange) {
        setTimeout(() => {
          onDataChange();
        }, 100);
      }

    } catch (error) {
      console.error('‚ùå T√∂rl√©si hiba:', error);
      alert('‚ùå Hiba t√∂rt√©nt a t√∂rl√©s sor√°n: ' + (error as Error).message);
    }
  };

  // üîπ LOADING & ERROR STATES
  if (loading) {
    return (
      <div className="flex items-center justify-center p-8">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
        <span className="ml-3 text-gray-600">Kar√°m t√∂rt√©nelem bet√∂lt√©se...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-6 bg-red-50 border border-red-200 rounded-lg">
        <h3 className="text-lg font-medium text-red-800 mb-2">‚ùå Bet√∂lt√©si hiba</h3>
        <p className="text-red-600 text-sm mb-4">{error}</p>
        <button
          onClick={loadAllData}
          className="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm"
        >
          üîÑ √öjrapr√≥b√°l√°s
        </button>
      </div>
    );
  }

  // üîπ MAIN RENDER
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold text-gray-900">
          üìö {mode === 'pen' ? `Kar√°m ${penNumber} T√∂rt√©nelem` : '√Ållat Kar√°m T√∂rt√©nelem'} 
          <span className="text-sm font-normal text-blue-600 ml-2">[V2 - Refaktor√°lt]</span>
        </h2>
        <div className="flex items-center space-x-4">
          <div className="text-sm text-gray-500">
            {kombinaltEsemenyek.length} esem√©ny
          </div>
          {mode !== 'view-only' && (
            <>
              <button
                onClick={() => openModal()}
                className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors"
              >
                ‚ûï √öj Esem√©ny
              </button>
              <button
                onClick={() => loadAllData()}
                className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
              >
                üîÑ Friss√≠t√©s
              </button>
            </>
          )}
        </div>
      </div>

      {/* Sz≈±r≈ë √©s pagination vez√©rl≈ëk */}
      <div className="flex justify-between items-center mb-6 p-4 bg-gray-50 rounded-lg">
        <div className="flex gap-2">
          <button
            onClick={() => {
              setEventFilter('all');
              setCurrentPage(1);
            }}
            className={`px-3 py-2 rounded-lg font-medium transition-colors ${
              eventFilter === 'all'
                ? 'bg-blue-500 text-white'
                : 'bg-white text-gray-700 hover:bg-gray-100'
            }`}
          >
            üè† √ñsszes ({kombinaltEsemenyek.length})
          </button>
          <button
            onClick={() => {
              setEventFilter('harem');
              setCurrentPage(1);
            }}
            className={`px-3 py-2 rounded-lg font-medium transition-colors ${
              eventFilter === 'harem'
                ? 'bg-pink-500 text-white'
                : 'bg-white text-gray-700 hover:bg-gray-100'
            }`}
          >
            üíï H√°rem ({kombinaltEsemenyek.filter(e => e.funkci === 'h√°rem').length})
          </button>
          <button
            onClick={() => {
              setEventFilter('movement');
              setCurrentPage(1);
            }}
            className={`px-3 py-2 rounded-lg font-medium transition-colors ${
              eventFilter === 'movement'
                ? 'bg-green-500 text-white'
                : 'bg-white text-gray-700 hover:bg-gray-100'
            }`}
          >
            üîÑ Mozgat√°sok ({kombinaltEsemenyek.filter(e => e.tipus === 'movement').length})
          </button>
        </div>
      </div>

      {/* Statistics */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-blue-50 p-4 rounded-lg">
          <div className="text-2xl font-bold text-blue-600">{kombinaltEsemenyek.length}</div>
          <div className="text-sm text-blue-600">√ñsszes esem√©ny</div>
        </div>
        <div className="bg-green-50 p-4 rounded-lg">
          <div className="text-2xl font-bold text-green-600">{kombinaltEsemenyek.filter(e => e.tipus === 'movement').length}</div>
          <div className="text-sm text-green-600">Mozgat√°sok</div>
        </div>
        <div className="bg-purple-50 p-4 rounded-lg">
          <div className="text-2xl font-bold text-purple-600">{kombinaltEsemenyek.filter(e => e.funkci === 'h√°rem').length}</div>
          <div className="text-sm text-purple-600">H√°rem esem√©nyek</div>
        </div>
        <div className="bg-orange-50 p-4 rounded-lg">
          <div className="text-2xl font-bold text-orange-600">{kombinaltEsemenyek.length > 0 ? kombinaltEsemenyek[0].pen_number || 'N/A' : 'N/A'}</div>
          <div className="text-sm text-orange-600">Jelenlegi kar√°m</div>
        </div>
      </div>

      {/* üéØ MAIN EVENT TIMELINE (kiszervezett komponens) */}
      <EventTimeline
        events={kombinaltEsemenyek}
        mode={mode}
        onEventEdit={openModal}
        onEventDelete={handleDelete}
        pagination={{
          currentPage,
          eventsPerPage,
          onPageChange: setCurrentPage
        }}
        filters={{
          eventFilter,
          onFilterChange: (filter: string) => setEventFilter(filter as 'all' | 'harem' | 'movement')
        }}
      />

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 className="text-xl font-bold mb-4">
              {editingEvent ? '‚úèÔ∏è Esem√©ny Szerkeszt√©se' : '‚ûï √öj Kar√°m Esem√©ny'}
              <span className="text-sm font-normal text-blue-600 ml-2">[V2]</span>
            </h3>

            <div className="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label className="block text-sm font-medium mb-2">D√°tum *</label>
                <input
                  type="date"
                  value={formData.datum}
                  onChange={(e) => setFormData({ ...formData, datum: e.target.value })}
                  className="w-full px-3 py-2 border rounded-md focus:ring-green-500 focus:border-green-500"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Id≈ëpont</label>
                <input
                  type="time"
                  value={formData.idopont}
                  onChange={(e) => setFormData({ ...formData, idopont: e.target.value })}
                  className="w-full px-3 py-2 border rounded-md focus:ring-green-500 focus:border-green-500"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4 mb-4">
              <div>
                <label className="block text-sm font-medium mb-2">Kar√°m funkci√≥ *</label>
                <select
                  value={formData.funkci}
                  onChange={(e) => setFormData({ ...formData, funkci: e.target.value })}
                  className="w-full px-3 py-2 border rounded-md focus:ring-green-500 focus:border-green-500"
                >
                  <option value="b√∂lcsi">üêÆ B√∂lcsi</option>
                  <option value="√≥vi">üêÑ √ìvi</option>
                  <option value="h√°rem">üêÑüíï H√°rem</option>
                  <option value="vemhes">üêÑüíñ Vemhes</option>
                  <option value="ellet≈ë">üêÑüçº Ellet≈ë</option>
                  <option value="teh√©n">üêÑüçº Teh√©n</option>
                  <option value="h√≠z√≥bika">üêÇ H√≠z√≥bika</option>
                  <option value="√ºres">‚≠ï √úres</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Esem√©ny oka *</label>
                <select
                  value={formData.esemenyTipus}
                  onChange={(e) => setFormData({ ...formData, esemenyTipus: e.target.value as any })}
                  className="w-full px-3 py-2 border rounded-md focus:ring-green-500 focus:border-green-500"
                >
                  <option value="pen_assignment">üìç Kar√°m hozz√°rendel√©s</option>
                  <option value="pen_movement">üîÑ Kar√°m v√°lt√°s</option>
                  <option value="function_change">‚öôÔ∏è Funkci√≥ v√°lt√°s</option>
                  <option value="breeding">üêÑüíï Teny√©szt√©s</option>
                  <option value="harem_entry">üêÑüíï H√°rembe helyez√©s</option>
                  <option value="breeding_entry">üêÑüíï Teny√©szt√©sbe √°ll√≠t√°s</option>
                  <option value="pregnancy">üêÑüíñ Vemhess√©g</option>
                  <option value="birth">üçº Ell√©s</option>
                  <option value="medical">üè• Orvosi kezel√©s</option>
                  <option value="quarantine">üö® Karant√©n</option>
                  <option value="culling">‚ùå Selejtez√©s</option>
                  <option value="other">üìù Egy√©b</option>
                </select>
              </div>
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium mb-2">C√©lkar√°m *</label>
              <select
                value={formData.hovaPen}
                onChange={(e) => setFormData({ ...formData, hovaPen: e.target.value })}
                className="w-full px-3 py-2 border rounded-md focus:ring-green-500 focus:border-green-500"
              >
                <option value="">V√°lassz karamot...</option>
                {availablePens.map(pen => (
                  <option key={pen.id} value={pen.id}>
                    {pen.pen_number} ({pen.location})
                  </option>
                ))}
              </select>
            </div>

            {/* H√°rem specifikus mez≈ëk */}
            {formData.funkci === 'h√°rem' && (
              <div className="mb-4 p-4 bg-pink-50 border border-pink-200 rounded">
                <h4 className="font-medium text-pink-800 mb-3">üíï H√°rem be√°ll√≠t√°sok [V2]</h4>

                <div className="mb-4">
                  <label className="block text-sm font-medium mb-2">üìÖ H√°rem kezdete</label>
                  <input
                    type="date"
                    value={formData.haremKezdete || formData.datum}
                    onChange={(e) => setFormData({ ...formData, haremKezdete: e.target.value })}
                    className="w-full px-3 py-2 border rounded-md focus:ring-pink-500 focus:border-pink-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium mb-2">üêÇ Teny√©szbik√°k ({availableBulls.length} el√©rhet≈ë)</label>
                  <div className="space-y-2 max-h-24 overflow-y-auto border rounded p-2 bg-white">
                    {availableBulls.map(bika => (
                      <div key={bika.id} className="flex items-center">
                        <input
                          type="checkbox"
                          id={`bika-${bika.id}`}
                          checked={formData.kivalasztottBikak.includes(bika.id)}
                          onChange={(e) => {
                            const isChecked = e.target.checked;
                            if (isChecked) {
                              setFormData({
                                ...formData,
                                kivalasztottBikak: [...formData.kivalasztottBikak, bika.id]
                              });
                            } else {
                              setFormData({
                                ...formData,
                                kivalasztottBikak: formData.kivalasztottBikak.filter(id => id !== bika.id)
                              });
                            }
                          }}
                          className="mr-3 h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500"
                        />
                        <label htmlFor={`bika-${bika.id}`} className="text-sm cursor-pointer">
                          <strong className="text-pink-900">{bika.name}</strong>
                          <span className="text-gray-600 ml-2">({bika.enar})</span>
                          {bika.kplsz && <span className="text-gray-500 text-xs ml-1">KPLSZ: {bika.kplsz}</span>}
                        </label>
                      </div>
                    ))}
                  </div>
                  <div className="mt-2 text-xs text-pink-600">
                    {formData.kivalasztottBikak.length} teny√©szbika kiv√°lasztva
                  </div>
                </div>
              </div>
            )}

            {/* √Ållat v√°laszt√°s (pen m√≥dban) */}
            {(mode === 'pen' && !editingEvent) && (
              <div className="space-y-4 mb-4">
                <div className="flex items-center space-x-2">
                  <span className="text-lg">üêÑ</span>
                  <h4 className="text-md font-medium text-gray-900">√ârintett √°llatok kiv√°laszt√°sa [V2]</h4>
                </div>

                <AnimalSelector
                  key={`animal-selector-v2-${showModal}-${Date.now()}`}
                  penId={undefined}
                  selected={formData.selectedAnimals}
                  onChange={(selected) => setFormData(prev => ({
                    ...prev,
                    selectedAnimals: selected
                  }))}
                  multiSelect={true}
                  currentOnly={false}
                  label="El√©rhet≈ë √°llatok"
                  placeholder="Keres√©s ENAR vagy kateg√≥ria alapj√°n..."
                  maxHeight="max-h-48"
                />

                {formData.selectedAnimals.length > 0 && (
                  <div className="text-sm text-green-600">
                    ‚úÖ {formData.selectedAnimals.length} √°llat kiv√°lasztva az esem√©nyhez
                  </div>
                )}
              </div>
            )}

            <div className="mb-4">
              <label className="block text-sm font-medium mb-2">üìù Megjegyz√©s</label>
              <textarea
                value={formData.megjegyzes}
                onChange={(e) => setFormData({ ...formData, megjegyzes: e.target.value })}
                rows={2}
                className="w-full px-3 py-2 border rounded-md focus:ring-green-500 focus:border-green-500"
                placeholder="Opcion√°lis megjegyz√©s..."
              />
            </div>

            <div className="mb-6">
              <label className="flex items-center">
                <input
                  type="checkbox"
                  checked={formData.torteneti}
                  onChange={(e) => setFormData({ ...formData, torteneti: e.target.checked })}
                  className="mr-2 h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500"
                />
                <span className="text-sm">üìö T√∂rt√©neti esem√©ny (m√∫ltbeli d√°tum)</span>
              </label>
            </div>

            <div className="flex justify-end gap-3 pt-6 border-t">
              <button
                onClick={() => setShowModal(false)}
                className="px-4 py-2 text-gray-600 border rounded-md hover:bg-gray-50"
              >
                M√©gse
              </button>
              <button
                onClick={handleSave}
                disabled={
                  !formData.datum ||
                  !formData.funkci ||
                  !formData.hovaPen ||
                  (mode === 'pen' && !editingEvent && formData.selectedAnimals.length === 0)
                }
                className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
              >
                üíæ Ment√©s [V2]
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TeljesKaramTortenelem_v2;