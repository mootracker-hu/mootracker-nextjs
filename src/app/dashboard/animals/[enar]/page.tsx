'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabase';
import type { Animal } from '@/types/animal-types'; // Felt√©telezve, hogy a t√≠pusok egy k√ºl√∂n f√°jlban vannak

// --- √öJ: A TAB-KOMPONENSEK IMPORT√ÅL√ÅSA ---
// Ezeket a f√°jlokat fogjuk l√©trehozni a components/tabs/ mapp√°ban
import SzaporitasTab from './components/tabs/SzaporitasTab';
import EllesTab from './components/tabs/EllesTab';
import DetailsTab from './components/tabs/DetailsTab';
import FamilyTab from './components/tabs/FamilyTab';
import EventLogTab from './components/tabs/EventLogTab';
import HybridAnimalPenHistory from '@/components/HybridAnimalPenHistory';

// --- GLOB√ÅLIS SEG√âDF√úGGV√âNYEK ---
const calculateAge = (birthDate: string) => {
  const birth = new Date(birthDate);
  const now = new Date();
  const diffMs = now.getTime() - birth.getTime();
  const years = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 365.25));
  const months = Math.floor((diffMs % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24 * 30.44));
  if (years > 0) return `${years} √©v ${months} h√≥`;
  return `${months} h√≥nap`;
};

const getShortId = (enar: string) => {
  if (!enar) return '';
  const numbers = enar.replace(/\D/g, '');
  return numbers.slice(-5);
};


export default function AnimalDetailPage() {
  const router = useRouter();

  // --- K√ñZPONTI √ÅLLAPOTKEZEL√âS (STATE) ---
  const [animal, setAnimal] = useState<Animal | null>(null);
  const [editedAnimal, setEditedAnimal] = useState<Animal | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<string>('reszletek');
  const [isEditing, setIsEditing] = useState(false);
  const [saving, setSaving] = useState(false);
  const [currentPen, setCurrentPen] = useState<string | null>(null);
  
  // --- K√ñZPONTI ADATKEZEL≈ê F√úGGV√âNYEK ---

  const fetchAnimal = async (enar: string) => {
    try {
      setLoading(true);
      setError(null);
      console.log('üîç Searching for animal with ENAR:', enar);
      const { data: animalData, error: supabaseError } = await supabase.from('animals').select(`*, animal_pen_assignments!left(id,pen_id,assigned_at,removed_at,assignment_reason,notes,pens(id,pen_number,location,pen_type))`).eq('enar', enar).single();
      if (supabaseError) {
        console.error('‚ùå Supabase error:', supabaseError);
        if (supabaseError.code === 'PGRST116') setError(`√Ållat nem tal√°lhat√≥: ${enar}`);
        else setError(`Adatb√°zis hiba: ${supabaseError.message}`);
        return;
      }
      if (!animalData) {
        setError(`Nincs √°llat ezzel az ENAR-ral: ${enar}`);
        return;
      }
      console.log('‚úÖ √Ållat alapadatok bet√∂ltve:', animalData);
      let enhancedAnimal = { ...animalData };
      if (animalData.father_enar) {
        console.log('‚úÖ K√∂zvetlen apa adatok m√°r jelen vannak.');
      } else if (animalData.anya_enar) {
        console.log('üîç Apa adatok keres√©se az anya alapj√°n:', animalData.anya_enar);
        const { data: birthData } = await supabase.from('births').select(`father_enar, father_name, father_kplsz, uncertain_paternity, possible_fathers`).eq('mother_enar', animalData.anya_enar).order('birth_date', { ascending: false }).limit(1);
        if (birthData && birthData.length > 0 && birthData[0].father_enar) {
            enhancedAnimal = { ...enhancedAnimal, ...birthData[0], father_source: 'birth_record' };
            console.log('‚úÖ Apa adatok hozz√°adva ell√©si rekordb√≥l.');
        } else {
            const { data: vvData } = await supabase.from('vv_results').select(`father_enar, father_name, father_kplsz, uncertain_paternity, possible_fathers`).eq('animal_enar', animalData.anya_enar).eq('pregnancy_status', 'vemhes').order('vv_date', { ascending: false }).limit(1);
            if(vvData && vvData.length > 0 && vvData[0].father_enar) {
                enhancedAnimal = { ...enhancedAnimal, ...vvData[0], father_source: 'vv_record' };
                console.log('‚úÖ Apa adatok hozz√°adva VV rekordb√≥l.');
            }
        }
      }
      console.log('üèÅ V√©gs≈ë √°llat objektum:', enhancedAnimal);
      setAnimal(enhancedAnimal);
      setEditedAnimal(enhancedAnimal);
    } catch (err) {
      console.error('‚ùå Fetch error:', err);
      setError('Hiba t√∂rt√©nt az adatok bet√∂lt√©se sor√°n');
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async () => {
    if (!editedAnimal || !animal) return;
    try {
      setSaving(true);
      const { error } = await supabase.from('animals').update({
        name: editedAnimal.name,
        kategoria: editedAnimal.kategoria,
        ivar: editedAnimal.ivar,
        statusz: editedAnimal.statusz,
        breed: editedAnimal.breed,
        birth_location: editedAnimal.birth_location,
        szuletesi_datum: editedAnimal.szuletesi_datum,
        bekerules_datum: editedAnimal.bekerules_datum,
        anya_enar: editedAnimal.anya_enar,
        kplsz: editedAnimal.kplsz,
        notes: editedAnimal.notes
      }).eq('enar', animal.enar);

      if (error) throw error;
      alert('‚úÖ √Ållat adatok sikeresen mentve!');
      setIsEditing(false);
      await fetchAnimal(animal.enar);
    } catch (error: any) {
      console.error('‚ùå Ment√©si hiba:', error);
      alert(`‚ùå Hiba t√∂rt√©nt a ment√©s sor√°n: ${error.message}`);
    } finally {
      setSaving(false);
    }
  };

  const fetchCurrentPen = async () => {
    if (!animal?.id) return;
    try {
      const { data: periodData, error } = await supabase
        .from('pen_history_periods')
        .select(`pens(pen_number)`)
        .contains('animal_ids', [animal.id])
        .is('end_date', null)
        .single();
      if (error) console.log("Nem a history period-ban van");
      if (periodData) {
        // @ts-ignore
        setCurrentPen(periodData.pens.pen_number);
        return;
      }
      
      const { data: assignmentData } = await supabase
        .from('animal_pen_assignments')
        .select(`pens(pen_number)`)
        .eq('animal_id', animal.id)
        .is('removed_at', null)
        .single();
      
      // @ts-ignore
      if (assignmentData) setCurrentPen(assignmentData.pens.pen_number);
      else setCurrentPen('Nincs hozz√°rendelve');

    } catch (error) {
      console.error('‚ùå Hiba a jelenlegi kar√°m meghat√°roz√°s√°ban:', error);
      setCurrentPen('Hiba t√∂rt√©nt');
    }
  };
  
  const updateField = (field: keyof Animal, value: any) => {
    if (editedAnimal === null) return;
    setEditedAnimal({ ...editedAnimal, [field]: value });
  };
  
  const forceUpdate = () => {
    if(animal?.enar) fetchAnimal(animal.enar);
  }

  // --- ADATBET√ñLT√âS (LIFECYCLE HOOKS) ---
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const pathname = window.location.pathname;
      const parts = pathname.split('/');
      const enar = decodeURIComponent(parts[parts.length - 1]);
      if (enar && enar !== '[enar]') {
        fetchAnimal(enar);
      } else {
        setLoading(false);
        setError("Nincs ENAR azonos√≠t√≥ az URL-ben.");
      }
    }
  }, []);

  useEffect(() => {
    if (animal?.id) {
      fetchCurrentPen();
    }
  }, [animal?.id]);

  // --- RENDEREL√âS ---
  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Adatok bet√∂lt√©se...</p>
        </div>
      </div>
    );
  }

  if (error || !animal || !editedAnimal) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-red-500 text-6xl mb-4">üêÑ</div>
          <h1 className="text-2xl font-bold text-gray-900 mb-2">Hiba t√∂rt√©nt</h1>
          <p className="text-gray-600 mb-4">{error || 'Ismeretlen hiba'}</p>
          <button onClick={() => router.back()} className="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-3 rounded-lg">
            ‚¨ÖÔ∏è Vissza
          </button>
        </div>
      </div>
    );
  }

  const tabs = [
    { id: 'reszletek', name: 'üìã R√©szletek' },
    { id: 'szaporitas', name: 'üî¨ Szapor√≠t√°s' },
    { id: 'elles', name: 'üêÑ Ell√©s' },
    { id: 'karam-tortenelem', name: 'üìö Kar√°m T√∂rt√©nelem' },
    { id: 'csalad', name: 'üêÑüíïüêÇ Csal√°d' },
    { id: 'esemenynaplo', name: 'üìä Esem√©nynapl√≥' },
    { id: 'egeszseg', name: '‚ù§Ô∏è Eg√©szs√©g' },
  ];

  const renderContent = () => {
    switch (activeTab) {
      case 'reszletek':
        return <DetailsTab 
                  animal={animal} 
                  editedAnimal={editedAnimal} 
                  isEditing={isEditing} 
                  updateField={updateField}
                  currentPen={currentPen}
                  fetchCurrentPen={fetchCurrentPen}
                  calculateAge={calculateAge}
                  getShortId={getShortId}
                />;
      case 'csalad':
        return <FamilyTab
                  animal={animal}
                  isEditing={isEditing}
                  updateField={updateField}
                  onUpdate={forceUpdate}
                />;
      case 'szaporitas':
        return <SzaporitasTab animal={animal} />;
      case 'elles':
        return <EllesTab animal={animal} />;
      case 'karam-tortenelem':
        return (
          <div className="p-6 bg-white rounded-lg shadow-sm border">
            <HybridAnimalPenHistory 
              animalEnar={animal.enar}
              animalId={animal.id.toString()}
            />
          </div>
        );
      case 'esemenynaplo':
        return <EventLogTab animal={animal} onUpdate={forceUpdate} />;
      default:
        return (
            <div className="bg-white rounded-lg shadow-sm border p-12 text-center">
                <div className="text-gray-400 text-6xl mb-4">üöß</div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">Fejleszt√©s alatt</h3>
                <p className="text-gray-500">Ez a funkci√≥ hamarosan el√©rhet≈ë lesz.</p>
            </div>
        );
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="mb-8">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <button onClick={() => router.back()} className="text-gray-400 hover:text-gray-600 p-2 transition-colors">
                ‚¨ÖÔ∏è
              </button>
              <div className="flex items-center">
                <span className="text-4xl mr-4">üêÑ</span>
                <div>
                  <h1 className="text-3xl font-bold text-gray-900">{animal.enar}</h1>
                  <p className="mt-2 text-gray-600">#{getShortId(animal.enar)} ‚Ä¢ {animal.kategoria}</p>
                </div>
              </div>
            </div>
            <div className="flex gap-3">
              {isEditing && (
                <button onClick={() => { setEditedAnimal(animal); setIsEditing(false); }} className="bg-white hover:bg-gray-50 text-gray-700 font-medium px-6 py-3 rounded-lg border border-gray-300 transition-colors inline-flex items-center">
                  <span className="mr-2">‚ùå</span> M√©gse
                </button>
              )}
              <button onClick={isEditing ? handleSave : () => setIsEditing(true)} disabled={saving} className="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-3 rounded-lg transition-colors disabled:opacity-50 inline-flex items-center">
                {saving ? (<> <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div> Ment√©s... </> ) : isEditing ? (<> <span className="mr-2">üíæ</span> Ment√©s </> ) : (<> <span className="mr-2">‚úèÔ∏è</span> Szerkeszt√©s </>)}
              </button>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-lg shadow-sm border mb-6">
          <div className="flex overflow-x-auto">
            {tabs.map((tab) => (
              <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center px-6 py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors ${activeTab === tab.id ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>
                {tab.name}
              </button>
            ))}
          </div>
        </div>
        
        <div>
          {renderContent()}
        </div>
      </div>
    </div>
  );
}
// Automatikus √©les√≠t√©s tesztje